<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jagaddhatri Puja Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for Inter font and general aesthetics */
        :root {
            --primary: #f87171; /* red-400 */
            --secondary: #3b82f6; /* blue-500 */
            --background: #f8f8f8;
            --card-bg: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            line-height: 1.6;
        }
        .card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        .pulse-loader {
            border-top-color: var(--primary);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        /* Style for the message box/modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="card p-6 w-11/12 max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
            <p id="modal-message" class="mb-6 text-gray-600">This is a message.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 hidden">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-700 transition duration-150">OK</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
        <div class="card p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-extrabold text-red-600 mb-4">Puja Finance Tracker</h1>
            <p class="text-gray-600 mb-6">Enter the family passcode to access the tracker.</p>
            <input type="password" id="passcode-input" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-red-500 focus:border-red-500" placeholder="Family Passcode">
            <button id="login-button" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150">
                Enter Tracker
            </button>
            <div id="login-error" class="text-red-500 text-sm mt-3 hidden">Invalid passcode. Please try again.</div>
        </div>
    </div>

    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold text-red-600">J-Puja Tracker</h1>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span class="font-medium text-gray-700">User ID:</span>
                    <span id="display-user-id" class="text-xs bg-gray-100 p-1 rounded-md cursor-help" title="Your unique ID for data segregation">Loading...</span>
                </div>
            </div>
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-1 sm:space-x-4 border-t border-gray-200">
                <button data-tab="dashboard" class="tab-button px-3 py-3 sm:px-5 text-gray-500 active">Dashboard</button>
                <button data-tab="budget-planner" class="tab-button px-3 py-3 sm:px-5 text-gray-500">Budget Planner</button>
                <button data-tab="add-transaction" class="tab-button px-3 py-3 sm:px-5 text-gray-500">Add Transaction</button>
                <button data-tab="transaction-history" class="tab-button px-3 py-3 sm:px-5 text-gray-500">History</button>
                <button data-tab="data-export" class="tab-button px-3 py-3 sm:px-5 text-gray-500">Data Export</button>
            </nav>
        </header>

        <main class="flex-grow max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 w-full">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Overview Dashboard</h2>
                <div id="dashboard-loader" class="text-center p-8 hidden">
                    <div class="pulse-loader w-8 h-8 border-4 rounded-full mx-auto mb-2"></div>
                    <p class="text-gray-500">Calculating Finances...</p>
                </div>
                <div id="dashboard-content" class="space-y-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="card p-5 bg-red-50 border-l-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500">Total Expense</p>
                            <p id="total-spent" class="mt-1 text-3xl font-semibold text-red-600">₹0</p>
                        </div>
                        <div class="card p-5 bg-green-50 border-l-4 border-green-500">
                            <p class="text-sm font-medium text-gray-500">Total Cash Inflow</p>
                            <p id="total-inflow" class="mt-1 text-3xl font-semibold text-green-600">₹0</p>
                        </div>
                        <div class="card p-5 bg-yellow-50 border-l-4 border-yellow-500">
                            <p class="text-sm font-medium text-gray-500">Cash Outflow</p>
                            <p id="cash-outflow" class="mt-1 text-3xl font-semibold text-yellow-600">₹0</p>
                        </div>
                        <div class="card p-5 bg-blue-50 border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-gray-500">Cash In Hand (Inflow - Cash Out)</p>
                            <p id="cash-in-hand" class="mt-1 text-3xl font-semibold text-blue-600">₹0</p>
                        </div>
                        <div class="card p-5 bg-purple-50 border-l-4 border-purple-500 col-span-2 md:col-span-1">
                            <p class="text-sm font-medium text-gray-500">UPI/Bank Outflow</p>
                            <p id="upi-outflow" class="mt-1 text-3xl font-semibold text-purple-600">₹0</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Budget Progress by Category</h3>
                        <div class="card p-4">
                            <div id="budget-progress-list" class="space-y-3">
                                <p class="text-gray-500">Set a budget in the **Budget Planner** tab to see the progress here!</p>
                            </div>
                        </div>
                    </div>

                    <!-- All Category Spending -->
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Detailed Category Spending</h3>
                        <div class="card p-4">
                            <div id="all-categories-list" class="space-y-2">
                                <!-- List of all categories and their totals will render here -->
                                <p class="text-gray-500">No outflow transactions recorded yet.</p>
                            </div>
                            <div id="category-grand-total" class="mt-4 pt-3 border-t border-gray-300 font-bold text-lg flex justify-between">
                                <span>TOTAL ALLOCATED EXPENSE:</span>
                                <span class="text-red-600">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Planner Tab -->
            <div id="tab-budget-planner" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Budget Planner</h2>
                <div class="card p-6">
                    <p class="text-gray-600 mb-4">Set the maximum spending limit for each expense category. Leave blank or 0 for no limit.</p>
                    <div id="budget-form-container" class="space-y-4">
                        <div id="budget-loader" class="text-center p-8">
                            <div class="pulse-loader w-6 h-6 border-4 rounded-full mx-auto mb-2"></div>
                            <p class="text-gray-500 text-sm">Loading categories...</p>
                        </div>
                    </div>
                    <button id="save-budget-btn" class="mt-6 w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                        <span id="budget-button-text">Save Budgets</span>
                        <div id="budget-save-spinner" class="pulse-loader w-5 h-5 border-4 rounded-full ml-3 hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Add Transaction Tab -->
            <div id="tab-add-transaction" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6" id="transaction-header">Add New Transaction</h2>
                <div class="card p-6">
                    <form id="transaction-form" class="space-y-4">
                        <input type="hidden" id="transaction-id" value="">
                        <input type="hidden" id="transaction-amount" value="0"> 

                        <!-- Transaction Type (INFLOW/OUTFLOW) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg flex-grow hover:bg-gray-50 has-[:checked]:border-green-500">
                                    <input type="radio" name="transactionType" value="INFLOW" required class="form-radio text-green-600" checked>
                                    <span class="font-medium text-green-600">INFLOW (Money In)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg flex-grow hover:bg-gray-50 has-[:checked]:border-red-500">
                                    <input type="radio" name="transactionType" value="OUTFLOW" required class="form-radio text-red-600">
                                    <span class="font-medium text-red-600">OUTFLOW (Money Out)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Date and Time -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="transaction-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div>
                                <label for="transaction-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                <input type="time" id="transaction-time" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                            </div>
                        </div>

                        <!-- Transaction Mode (Dynamic based on Type) -->
                        <div>
                            <label for="transaction-mode" class="block text-sm font-medium text-gray-700 mb-1" id="mode-label">Inflow Source/Bank</label>
                            <select id="transaction-mode" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></select>
                        </div>

                        <!-- Amount/Bill Total -->
                        <div>
                            <label for="transaction-total-amount" class="block text-sm font-medium text-gray-700 mb-1">Total Transaction Amount (INR)</label>
                            <input type="number" id="transaction-total-amount" required min="0.01" step="0.01" placeholder="e.g., 5000.00 (Total Amount)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        </div>

                        <!-- OUTFLOW Specific Fields -->
                        <div id="outflow-fields" class="space-y-4 hidden">

                            <!-- Payment Status (Full/Advance/Due) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <div class="flex space-x-2 overflow-x-auto pb-1">
                                    <label class="flex-shrink-0 flex items-center space-x-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 has-[:checked]:border-red-500">
                                        <input type="radio" name="paymentStatus" value="FULL" class="form-radio text-red-600" checked>
                                        <span>Full Payment</span>
                                    </label>
                                    <label class="flex-shrink-0 flex items-center space-x-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 has-[:checked]:border-red-500">
                                        <input type="radio" name="paymentStatus" value="ADVANCE" class="form-radio text-red-600">
                                        <span>Advance Payment</span>
                                    </label>
                                    <label class="flex-shrink-0 flex items-center space-x-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 has-[:checked]:border-red-500">
                                        <input type="radio" name="paymentStatus" value="DUE" class="form-radio text-red-600">
                                        <span>Clear Due</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Advance/Due Conditional Fields -->
                            <div id="advance-due-fields" class="card p-4 bg-yellow-50 border border-yellow-200 hidden">
                                <div id="due-clearance-section" class="hidden">
                                    <label for="open-advance-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Open Advance Transaction</label>
                                    <select id="open-advance-selector" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-3"></select>
                                    <div id="selected-due-summary" class="text-sm text-gray-600 p-2 bg-yellow-100 rounded-lg hidden"></div>
                                </div>

                                <div id="advance-fields" class="hidden">
                                    <label for="expected-amount" class="block text-sm font-medium text-gray-700 mb-1">Full Expected Amount (Optional)</label>
                                    <input type="number" id="expected-amount" placeholder="e.g., 10000 (Estimate for the entire service/item)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                                </div>
                            </div>

                            <!-- Split Expense Section -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2 mt-4 flex justify-between items-center">
                                    <span>Category Splits</span>
                                    <span id="split-summary" class="text-xs font-normal text-gray-500">Split Total: ₹0</span>
                                </label>
                                <div id="category-split-container" class="space-y-3 p-4 border rounded-lg bg-gray-50">
                                </div>
                                <button type="button" id="add-split-btn" class="mt-3 w-full py-2 border border-gray-300 text-gray-600 font-medium rounded-lg hover:bg-gray-100 transition duration-150">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block"></i> Add Category Split
                                </button>
                            </div>

                        </div>

                        <!-- Narration/Description -->
                        <div>
                            <label for="transaction-narration" class="block text-sm font-medium text-gray-700 mb-1">Narration (Optional)</label>
                            <textarea id="transaction-narration" rows="2" placeholder="Brief description of the transaction..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                        </div>

                        <!-- File Uploads -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Bill/Receipts (Max 7 files)</label>
                            <input type="file" id="bill-upload" multiple accept="image/*, application/pdf" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                            <p class="text-xs text-gray-500 mt-1">**IMPORTANT:** Max 7 files. Use the input above to **select all files at once, or repeatedly** to accumulate them here. Max 200KB per file.</p>
                            <div id="file-preview-list" class="mt-2 space-y-2">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" id="submit-transaction-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center">
                            <span id="transaction-button-text">Record Transaction</span>
                            <div id="transaction-spinner" class="pulse-loader w-5 h-5 border-4 rounded-full ml-3 hidden"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Transaction History Tab -->
            <div id="tab-transaction-history" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Transaction History</h2>
                <div id="history-loader" class="text-center p-8">
                    <div class="pulse-loader w-8 h-8 border-4 rounded-full mx-auto mb-2"></div>
                    <p class="text-gray-500">Fetching history from database...</p>
                </div>
                <div id="transaction-list" class="space-y-4">
                </div>
            </div>
            
            <!-- Data Export Tab -->
            <div id="tab-data-export" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Data Export Query</h2>
                <div class="card p-6 space-y-6">
                    <h3 class="text-xl font-semibold text-gray-800">1. Select Columns for Report</h3>
                    <div id="column-selection" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <!-- Default Columns -->
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="date" checked> <span>Date & Time</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="type" checked> <span>Type</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="mode" checked> <span>Mode</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="amount" checked> <span>Amount Paid</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="status"> <span>Payment Status</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="category"> <span>Category</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="narration"> <span>Narration</span></label>
                        <!-- Budget Columns -->
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="budgetLimit"> <span>Budget Limit</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="spentPerCategory"> <span>Spent per Category</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="budgetVariance"> <span>Budget Variance</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="col" value="expectedAmount"> <span>Expected Advance Amount</span></label>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800">2. Filter Report Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Type</label>
                            <select id="filter-type" class="w-full p-2 border rounded-lg">
                                <option value="all">All Types</option>
                                <option value="INFLOW">INFLOW</option>
                                <option value="OUTFLOW">OUTFLOW</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Status</label>
                            <select id="filter-status" class="w-full p-2 border rounded-lg">
                                <option value="all">All Statuses</option>
                                <option value="FULL">FULL</option>
                                <option value="ADVANCE">ADVANCE (Open/Closed)</option>
                                <option value="OPEN_ADVANCE">ADVANCE (Open Only)</option>
                                <option option value="DUE">DUE Clearance</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Category</label>
                            <select id="filter-category" class="w-full p-2 border rounded-lg">
                                <option value="all">All Categories</option>
                                <!-- Categories populated by JS -->
                            </select>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-800 pt-4">3. Group & Order Results</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Group By (Aggregation)</label>
                            <select id="group-by" class="w-full p-2 border rounded-lg">
                                <option value="">None (Show All Transactions)</option>
                                <option value="category">Category</option>
                                <option value="type">Transaction Type</option>
                                <option value="mode">Payment Mode</option>
                                <option value="status">Payment Status</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Order By (Sort Column)</label>
                            <select id="order-by" class="w-full p-2 border rounded-lg">
                                <option value="date">Date & Time</option>
                                <option value="amount">Amount</option>
                                <option value="category">Category</option>
                                <option value="spentPerCategory">Spent per Category</option>
                                <option value="budgetVariance">Budget Variance</option>
                                <option value="type">Type</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Order Direction</label>
                            <select id="order-dir" class="w-full p-2 border rounded-lg">
                                <option value="desc">Descending (Latest/Highest First)</option>
                                <option value="asc">Ascending (Oldest/Lowest First)</option>
                            </select>
                        </div>
                    </div>

                    <button id="run-query-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150">
                        Generate Report Table
                    </button>
                    
                    <h3 class="text-xl font-semibold text-gray-800 pt-4">4. Report Output</h3>
                    <div id="report-actions" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="copy-clipboard-btn" class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 disabled:opacity-50" disabled>
                            <i data-lucide="copy" class="w-4 h-4 inline-block mr-2"></i> Copy to Clipboard (CSV)
                        </button>
                        <button id="download-csv-btn" class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 disabled:opacity-50" disabled>
                            <i data-lucide="download" class="w-4 h-4 inline-block mr-2"></i> Download CSV
                        </button>
                    </div>

                    <div id="report-output-container" class="overflow-x-auto card p-2 border border-gray-300 bg-white">
                        <p class="text-gray-500 text-sm p-4">Click "Generate Report Table" to see your results here.</p>
                        <table id="report-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <!-- Report data inserted here -->
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, onSnapshot, collection, query,
            addDoc, deleteDoc, updateDoc, getDocs, getDoc, where,
            writeBatch, runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level (useful for debugging in the console)
        setLogLevel('Debug');

        // --- GLOBAL CONFIGURATION & SETUP ---

        // --- START FIREBASE CONFIGURATION (Your correct details) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBw3ae2AHnVRPi4KkcF6K257HYC8q_ro0A",
            authDomain: "jpuja-tracker.firebaseapp.com",
            projectId: "jpuja-tracker",
            storageBucket: "jpuja-tracker.firebasestorage.app",
            appId: "1:740381845015:web:f3f876d5ad0b1d55d11e52",
        };
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; 
        // --- END FIREBASE CONFIGURATION ---


        let db, auth, app, userId = null;
        let allTransactions = []; 
        let allBudgets = {}; 
        let openAdvanceTransactions = []; 
        
        let pendingFiles = []; 
        let pendingSplits = []; 
        let currentTotalAmount = 0; 
        let currentReportData = ''; // Stores CSV data for export

        const FAMILY_PASSCODE = "jpuja2025!"; 

        const INFLOW_MODES = ['HDFC', 'IDFC', 'Sarmistha']; 
        const OUTFLOW_MODES = ['Cash', 'UPI HDFC', 'UPI IDFC', 'Bank Transfer']; 

        const EXPENSE_CATEGORIES = [
            'Bhog- Sweets', 'Bhog- Grocery', 'Bhog- Maru', 'Bhog- Fruits',
            'Food- Sweets', 'Food- Grocery', 'Food- Vegetables', 'Food- Kajol/Cook',
            'Dashakarma- Purohit', 'Dashakarma Others',
            'Puja- Pratima', 'Puja- Dhaki', 'Puja- Purohit', 'Puja- Purohit Assistant', 'Puja- Flowers',
            'Dress Material- Puja', 'Dress Material- Others',
            'Travel- Local Conveyance', 'Travel- Car',
            'Plates, cups etc', 'Lights', 'Pandal', 'House cleaning', 'House Cleaning Shibu+wife', 'House repairs', 'Gas', 'Water', 'Other'
        ].sort();

        // DOM Element references
        const $ = (id) => document.getElementById(id);
        const modal = $('message-modal');
        const modalTitle = $('modal-title');
        const modalMessage = $('modal-message');
        const modalConfirm = $('modal-confirm');
        const modalCancel = $('modal-cancel');

        // --- UTILITY FUNCTIONS ---

        const showModal = (title, message, isConfirm = false) => {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;

                modalCancel.onclick = () => {
                    modal.classList.add('opacity-0', 'invisible');
                    resolve(false);
                };

                modalConfirm.onclick = () => {
                    modal.classList.add('opacity-0', 'invisible');
                    resolve(true);
                };

                if (isConfirm) {
                    modalCancel.classList.remove('hidden');
                    modalConfirm.textContent = 'Yes, Proceed';
                    modalConfirm.classList.remove('bg-red-500', 'hover:bg-red-600');
                    modalConfirm.classList.add('bg-blue-500', 'hover:bg-blue-600');
                } else {
                    modalCancel.classList.add('hidden');
                    modalConfirm.textContent = 'OK';
                    modalConfirm.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    modalConfirm.classList.add('bg-red-500', 'hover:bg-red-600');
                }

                modal.classList.remove('opacity-0', 'invisible');
            });
        };

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const MAX_FILE_SIZE_BYTES = 200 * 1024;
                if (file.size > MAX_FILE_SIZE_BYTES) {
                    reject(new Error(`File "${file.name}" is too large (${(file.size / 1024).toFixed(2)} KB). Max allowed size is 200 KB.`));
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve({
                    name: file.name,
                    data: reader.result 
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const getDateTime = (dateStr, timeStr) => {
            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, minute] = timeStr.split(':').map(Number);
            return new Date(year, month - 1, day, hour, minute);
        }

        // --- FIREBASE INITIALIZATION AND AUTH ---

        const initFirebase = async () => {
            try {
                if (!firebaseConfig.projectId) {
                     throw new Error("Firebase configuration error.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        $('display-user-id').textContent = userId;

                        setupFirestoreListeners();
                        initTransactionForm();
                        renderBudgetInputs(); 
                        setupExportLogic(); // Initialize export logic
                    } else {
                        userId = crypto.randomUUID();
                        $('display-user-id').textContent = userId;
                        setupFirestoreListeners();
                        initTransactionForm();
                        renderBudgetInputs();
                        setupExportLogic();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                await showModal("Setup Error", `Could not initialize the database. Details: ${error.message}`, false);
            }
        };

        // --- FIRESTORE COLLECTION PATHS ---

        const getTransactionCollectionRef = () => {
            if (!db || !userId) throw new Error("DB or User ID not initialized.");
            return collection(db, `artifacts/${appId}/users/${userId}/transactions`);
        };

        const getBudgetCollectionRef = () => {
            if (!db || !userId) throw new Error("DB or User ID not initialized.");
            return collection(db, `artifacts/${appId}/users/${userId}/budgets`);
        };

        // --- DATA LISTENERS (REAL-TIME UPDATES) ---

        const setupFirestoreListeners = () => {
            onSnapshot(getTransactionCollectionRef(), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    dateTime: getDateTime(doc.data().date, doc.data().time || '00:00')
                }));
                allTransactions.sort((a, b) => b.dateTime - a.dateTime);

                openAdvanceTransactions = allTransactions.filter(t =>
                    t.type === 'OUTFLOW' && t.status === 'ADVANCE' && !t.isClosed
                );

                renderDashboard();
                renderTransactionHistory();
                updateDueSelector();
            }, (error) => {
                console.log("Error fetching transactions:", error);
                if (error.code !== 'permission-denied') {
                     showModal("Data Error", `Failed to load transactions: ${error.message}`);
                }
            });

            onSnapshot(getBudgetCollectionRef(), (snapshot) => {
                allBudgets = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    allBudgets[data.category] = {
                        limit: data.limit,
                        docId: doc.id
                    };
                });
                renderDashboard(); 
                renderBudgetInputs(); 
            }, (error) => {
                console.log("Error fetching budgets:", error);
                if (error.code !== 'permission-denied') {
                    showModal("Data Error", `Failed to load budgets: ${error.message}`);
                }
            });
        };

        // --- DASHBOARD LOGIC (UPDATED FOR NEW METRICS & BACKWARD COMPATIBILITY) ---

        const renderDashboard = () => {
            $('dashboard-loader').classList.add('hidden');

            let totalSpent = 0;
            let totalInflow = 0;
            let cashOutflow = 0; 
            let upiOutflow = 0;

            const spendingByCategory = {};
            const countByCategory = {};

            allTransactions.forEach(t => {
                const txAmount = parseFloat(t.amount) || 0; 
                
                if (t.type === 'INFLOW') {
                    totalInflow += txAmount;
                } else { // OUTFLOW
                    totalSpent += txAmount;
                    if (t.mode === 'Cash') {
                        cashOutflow += txAmount;
                    } else {
                        upiOutflow += txAmount;
                    }

                    // --- BACKWARD COMPATIBILITY & SPLIT AGGREGATION ---
                    const splitsToProcess = (t.splits && t.splits.length > 0)
                        ? t.splits
                        : (t.category ? [{ category: t.category, amount: t.amount }] : []);
                    
                    splitsToProcess.forEach(split => {
                        const cat = split.category;
                        const amt = parseFloat(split.amount) || 0;

                        spendingByCategory[cat] = (spendingByCategory[cat] || 0) + amt;
                        
                        // Count unique transaction receipts based on the primary category (tx.category)
                        if (t.category) {
                           countByCategory[t.category] = (countByCategory[t.category] || 0) + 1;
                        }
                    });
                }
            });

            const cashInHand = totalInflow - cashOutflow; 

            // Update Summary Cards
            $('total-spent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;
            $('total-inflow').textContent = `₹${totalInflow.toLocaleString('en-IN')}`;
            $('cash-outflow').textContent = `₹${cashOutflow.toLocaleString('en-IN')}`;
            $('upi-outflow').textContent = `₹${upiOutflow.toLocaleString('en-IN')}`;
            $('cash-in-hand').textContent = `₹${cashInHand.toLocaleString('en-IN')}`;


            // Determine Cash in Hand color
            const cashInHandCard = $('cash-in-hand').closest('.card');
            cashInHandCard.classList.remove('bg-red-50', 'bg-green-50', 'border-blue-500', 'border-red-500', 'border-green-500');
            $('cash-in-hand').classList.remove('text-blue-600', 'text-red-600', 'text-green-600');

            if (cashInHand >= 0) {
                 cashInHandCard.classList.add('bg-green-50', 'border-green-500');
                 $('cash-in-hand').classList.add('text-green-600');
            } else {
                 cashInHandCard.classList.add('bg-red-50', 'border-red-500');
                 $('cash-in-hand').classList.add('text-red-600');
            }


            // Render Budget Progress List
            let budgetHtml = '';
            let hasBudget = false;

            EXPENSE_CATEGORIES.forEach(category => {
                const limit = allBudgets[category]?.limit || 0;
                const spent = spendingByCategory[category] || 0;

                if (limit > 0) {
                    hasBudget = true;
                    const progress = limit > 0 ? Math.min(100, (spent / limit) * 100) : 0;
                    const overBudget = spent > limit;
                    const remaining = limit - spent;
                    const color = overBudget ? 'bg-red-500' : 'bg-blue-500';

                    budgetHtml += `
                        <div class="p-3 border rounded-lg">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium text-gray-700">${category}</span>
                                <span class="text-sm font-semibold ${overBudget ? 'text-red-600' : 'text-blue-600'}">
                                    ₹${spent.toLocaleString('en-IN')} / ₹${limit.toLocaleString('en-IN')}
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="${color} h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                ${overBudget ? `₹${(spent - limit).toLocaleString('en-IN')} OVER BUDGET` : `₹${remaining.toLocaleString('en-IN')} Remaining`}
                            </p>
                        </div>
                    `;
                }
            });

            const budgetListElement = $('budget-progress-list');
            if (hasBudget) {
                budgetListElement.innerHTML = budgetHtml;
            } else {
                budgetListElement.innerHTML = '<p class="text-gray-500 p-2">No budgets set. Set limits in the **Budget Planner** tab!</p>';
            }

            // --- NEW: Render All Categories List ---
            const allCategoriesList = $('all-categories-list');
            const categoryTotalElement = $('category-grand-total').querySelector('span:last-child');
            allCategoriesList.innerHTML = '';

            let totalAllocatedExpense = 0;
            let categoryListHtml = '';

            // 1. Filter and sort categories that actually have spending
            const spentCategories = EXPENSE_CATEGORIES
                .filter(cat => spendingByCategory[cat] > 0)
                .map(category => {
                    const spent = spendingByCategory[category];
                    totalAllocatedExpense += spent;
                    return { category, spent };
                })
                .sort((a, b) => b.spent - a.spent); // Sort by highest expense first

            if (spentCategories.length > 0) {
                spentCategories.forEach(({ category, spent }) => {
                    categoryListHtml += `
                        <div class="flex justify-between items-center p-2 border-b border-gray-100">
                            <span class="font-medium text-gray-700">${category}</span>
                            <span class="text-base font-semibold text-gray-800">₹${spent.toLocaleString('en-IN')}</span>
                        </div>
                    `;
                });
                allCategoriesList.innerHTML = categoryListHtml;
            } else {
                allCategoriesList.innerHTML = '<p class="text-gray-500 p-2">No outflow transactions recorded yet.</p>';
            }
            
            // 2. Update the Grand Total (This should match the Total Expense card)
            categoryTotalElement.textContent = `₹${totalAllocatedExpense.toLocaleString('en-IN')}`;
            // --- END NEW: Render All Categories List ---
        };

        // --- BUDGET PLANNER LOGIC (NO CHANGE) ---

        const renderBudgetInputs = () => {
            const container = $('budget-form-container');
            container.innerHTML = ''; 

            EXPENSE_CATEGORIES.forEach(category => {
                const currentLimit = allBudgets[category]?.limit || '';
                const inputId = `budget-input-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;

                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 gap-4 items-center';
                div.innerHTML = `
                    <label for="${inputId}" class="block text-sm font-medium text-gray-700">${category}</label>
                    <input type="number" id="${inputId}" data-category="${category}" value="${currentLimit}" min="0" step="1"
                            placeholder="Limit (INR)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right">
                `;
                container.appendChild(div);
            });
            // Populate category filter dropdown for the export tab
            populateExportCategoryFilter();
        };

        const handleSaveBudgets = async () => {
            const button = $('save-budget-btn');
            const buttonText = $('budget-button-text');
            const spinner = $('budget-save-spinner');

            buttonText.textContent = 'Saving...';
            spinner.classList.remove('hidden');
            button.disabled = true;

            const inputs = $('budget-form-container').querySelectorAll('input[type="number"]');
            const budgetData = {};

            inputs.forEach(input => {
                const category = input.dataset.category;
                const limit = parseFloat(input.value) || 0;
                budgetData[category] = limit;
            });

            try {
                const batch = writeBatch(db);
                const budgetColRef = getBudgetCollectionRef();

                // 1. Update/Add Budgets
                EXPENSE_CATEGORIES.forEach(category => {
                    const limit = budgetData[category];
                    const existingDocId = allBudgets[category]?.docId;

                    if (limit > 0) {
                        const docRef = existingDocId ? doc(budgetColRef, existingDocId) : doc(budgetColRef);
                        batch.set(docRef, { category: category, limit: limit });
                    } else if (existingDocId) {
                        const docRef = doc(budgetColRef, existingDocId);
                        batch.delete(docRef);
                    }
                });

                await batch.commit();
                await showModal("Success!", "Your budget limits have been successfully saved.", false);

            } catch (error) {
                console.error("Error saving budgets:", error);
                await showModal("Save Error", `Failed to save budgets: ${error.message}`, false);
            } finally {
                buttonText.textContent = 'Save Budgets';
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        };

        // --- ADD TRANSACTION LOGIC ---

        const syncPaymentAmounts = () => {
            const type = document.querySelector('input[name="transactionType"]:checked')?.value;
            const status = document.querySelector('input[name="paymentStatus"]:checked')?.value;
            const totalAmountInput = $('transaction-total-amount');

            if (type === 'OUTFLOW' && status === 'FULL') {
                const totalBill = parseFloat(totalAmountInput.value) || 0;
                currentTotalAmount = totalBill; 
                totalAmountInput.value = currentTotalAmount.toFixed(2);
            } else {
                currentTotalAmount = parseFloat(totalAmountInput.value) || 0;
            }
            updateCategorySplitTotal(); 
        };
        
        const syncSplitItemsFromDOM = () => {
            document.querySelectorAll('#category-split-container > div').forEach(itemDiv => {
                const index = parseInt(itemDiv.querySelector('[data-field]').dataset.index);
                const categorySelect = itemDiv.querySelector('[data-field="category"]');
                const amountInput = itemDiv.querySelector('[data-field="amount"]');

                if (pendingSplits[index]) {
                    pendingSplits[index].category = categorySelect.value;
                    pendingSplits[index].amount = parseFloat(amountInput.value) || 0;
                }
            });
        };

        const initTransactionForm = (transactionToModify = null) => {
            const form = $('transaction-form');
            const typeInputs = form.querySelectorAll('input[name="transactionType"]');
            const statusInputs = form.querySelectorAll('input[name="paymentStatus"]');

            pendingFiles = []; 
            pendingSplits = [];
            currentTotalAmount = 0;
            $('category-split-container').innerHTML = ''; 

            if (!transactionToModify) {
                $('transaction-id').value = '';
                $('transaction-narration').value = '';
                $('transaction-total-amount').value = '';
                $('transaction-amount').value = 0; 
                $('expected-amount').value = ''; 
                
                document.querySelector('input[name="transactionType"][value="INFLOW"]').checked = true;
                document.querySelector('input[name="paymentStatus"][value="FULL"]').checked = true;
                $('transaction-header').textContent = 'Add New Transaction';
                $('transaction-button-text').textContent = 'Record Transaction';

                const now = new Date();
                const dateStr = now.toISOString().substring(0, 10);
                const timeStr = now.toTimeString().substring(0, 5); 
                
                $('transaction-date').value = dateStr;
                $('transaction-time').value = timeStr;
            }

            typeInputs.forEach(input => input.addEventListener('change', updateTransactionFormUI));
            statusInputs.forEach(input => input.addEventListener('change', updateTransactionFormUI));
            $('open-advance-selector').addEventListener('change', updateDueClearanceSummary);
            $('bill-upload').addEventListener('change', handleNewFileSelection); 
            $('add-split-btn').addEventListener('click', addCategorySplit);
            
            $('transaction-total-amount').addEventListener('input', (e) => {
                currentTotalAmount = parseFloat(e.target.value) || 0;
                updateCategorySplitTotal(); 
                
                const type = document.querySelector('input[name="transactionType"]:checked')?.value;
                const status = document.querySelector('input[name="paymentStatus"]:checked')?.value;
                if (type === 'OUTFLOW' && status === 'FULL') {
                     syncPaymentAmounts(); 
                }
            });

            updateTransactionFormUI();

            if (transactionToModify) {
                populateFormForModification(transactionToModify);
            }
            
            renderCategorySplits(); 
            renderFilePreviewList(transactionToModify); 
        };
        
        // Renders the dynamic split input rows
        const renderCategorySplits = () => {
            const container = $('category-split-container');
            container.innerHTML = '';
            
            pendingSplits.forEach((split, index) => {
                const status = document.querySelector('input[name="paymentStatus"]:checked').value;
                const isDue = status === 'DUE';
                const isSingleSplit = pendingSplits.length === 1;

                const splitElement = document.createElement('div');
                splitElement.className = 'flex flex-col sm:grid sm:grid-cols-10 gap-2 items-end p-2 bg-white border rounded-lg shadow-sm';
                splitElement.innerHTML = `
                    <div class="sm:col-span-6">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
                        <select data-index="${index}" data-field="category" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm">
                            ${EXPENSE_CATEGORIES.map(c => `<option value="${c}" ${c === split.category ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label class="block text-xs font-medium text-gray-500 mb-1">${isDue ? 'Amount to Clear' : 'Split Amount'}</label>
                        <input type="number" data-index="${index}" data-field="amount" value="${split.amount}" required min="0.01" step="0.01" placeholder="Amount" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm">
                    </div>
                    <div class="sm:col-span-1 flex justify-end items-end h-full">
                        <button type="button" data-index="${index}" class="remove-split-btn p-2 text-red-500 hover:text-red-700 rounded-full" title="Remove Split" ${isDue || (isSingleSplit && !isDue) ? 'disabled' : ''}>
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                container.appendChild(splitElement);
            });

            container.querySelectorAll('select, input').forEach(el => {
                el.addEventListener('change', handleSplitChange);
                el.addEventListener('input', handleSplitChange);
            });
            container.querySelectorAll('.remove-split-btn').forEach(btn => {
                btn.addEventListener('click', removeCategorySplit);
            });
            
            updateCategorySplitTotal();
            lucide.createIcons(); 
        };

        const handleSplitChange = (e) => {
            const index = parseInt(e.target.dataset.index);
            const field = e.target.dataset.field;
            let value = e.target.value;

            if (field === 'amount') {
                value = parseFloat(value) || 0;
            }

            if (pendingSplits[index]) {
                pendingSplits[index][field] = value;
            }
            
            if (field === 'amount') {
                updateCategorySplitTotal();
            }
        };

        const updateCategorySplitTotal = () => {
            syncSplitItemsFromDOM(); 
            const totalSplitAmount = pendingSplits.reduce((sum, split) => sum + (parseFloat(split.amount) || 0), 0);
            const totalInput = parseFloat($('transaction-total-amount').value) || 0;
            
            const discrepancy = totalInput - totalSplitAmount;
            
            let summaryText = `Split Total: ₹${totalSplitAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            let summaryClass = 'text-green-600';

            if (Math.abs(discrepancy) > 0.001) { 
                summaryClass = 'text-red-600 font-bold';
                summaryText += ` (Diff: ₹${discrepancy.toLocaleString('en-IN', { minimumFractionDigits: 2 })})`;
            }

            const summarySpan = $('split-summary');
            summarySpan.textContent = summaryText;
            summarySpan.className = `text-xs font-normal ${summaryClass}`;
        };

        const addCategorySplit = () => {
            const status = document.querySelector('input[name="paymentStatus"]:checked').value;
            if (status === 'DUE' && pendingSplits.length > 0) {
                 showModal("Validation Error", "A **Due Clearance** transaction is only allowed one split.", false);
                 return;
            }
            
            pendingSplits.push({
                category: EXPENSE_CATEGORIES[0], 
                amount: 0,
            });
            renderCategorySplits();
        };

        const removeCategorySplit = (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            const status = document.querySelector('input[name="paymentStatus"]:checked').value;

            if (status === 'DUE' || pendingSplits.length === 1) {
                 showModal("Validation Error", "Cannot remove the only split for this transaction type/state.", false);
                 return;
            }

            pendingSplits.splice(index, 1);
            renderCategorySplits();
        };

        const populateFormForModification = (tx) => {
            $('transaction-header').textContent = `Modify Transaction (${tx.id.substring(0, 8)}...)`;
            $('transaction-button-text').textContent = 'Save Changes';
            $('transaction-id').value = tx.id;

            pendingFiles = tx.files || [];
            
            const txSplits = (tx.splits && tx.splits.length > 0)
                 ? tx.splits
                 : (tx.category ? [{ category: tx.category, amount: tx.amount }] : []);

            pendingSplits = JSON.parse(JSON.stringify(txSplits));
            
            document.querySelector(`input[name="transactionType"][value="${tx.type}"]`).checked = true;
            updateTransactionFormUI(); 

            $('transaction-date').value = tx.date;
            $('transaction-time').value = tx.time || '00:00';
            $('transaction-total-amount').value = tx.amount;
            currentTotalAmount = tx.amount;
            $('transaction-narration').value = tx.narration || '';
            $('transaction-mode').value = tx.mode;

            if (tx.type === 'OUTFLOW') {
                 document.querySelector(`input[name="paymentStatus"][value="${tx.status}"]`).checked = true;
                 updateTransactionFormUI(); 

                 if (tx.status === 'ADVANCE') {
                    $('expected-amount').value = tx.expectedAmount || '';
                 }
                
                 if (tx.status === 'DUE' && tx.openDueId) {
                     setTimeout(() => {
                         $('open-advance-selector').value = tx.openDueId;
                         updateDueClearanceSummary();
                     }, 100); 
                 }
            }
            
            renderCategorySplits(); 
            renderFilePreviewList(tx);
        };

        const handleTransactionSubmit = async (e) => {
            e.preventDefault();

            const button = $('submit-transaction-btn');
            const buttonText = $('transaction-button-text');
            const spinner = $('transaction-spinner');
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const isModification = !!$('transaction-id').value;

            buttonText.textContent = 'Processing...';
            spinner.classList.remove('hidden');
            button.disabled = true;
            
            if (type === 'OUTFLOW') {
                syncSplitItemsFromDOM();
            }

            const txId = $('transaction-id').value;
            let currentTx = isModification ? allTransactions.find(t => t.id === txId) : null;
            let transactionRef = isModification ? doc(getTransactionCollectionRef(), txId) : doc(getTransactionCollectionRef());

            const date = $('transaction-date').value;
            const time = $('transaction-time').value;
            const mode = $('transaction-mode').value;
            const totalAmount = parseFloat($('transaction-total-amount').value);
            $('transaction-amount').value = totalAmount; 
            const narration = $('transaction-narration').value;

            if (isNaN(totalAmount) || totalAmount <= 0) {
                 await showModal("Validation Error", `Please enter a valid **Total Transaction Amount (INR)** greater than zero.`, false);
                 buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                 spinner.classList.add('hidden');
                 button.disabled = false;
                 return;
            }

            let status = 'FULL';
            let openDueId = null; 
            let finalSplits = null;
            let expectedAmount = null; 
            let category = null;

            if (type === 'OUTFLOW') {
                status = document.querySelector('input[name="paymentStatus"]:checked').value;
                
                finalSplits = pendingSplits.map(s => ({ category: s.category, amount: parseFloat(s.amount) || 0 }));

                const totalSplitAmount = finalSplits.reduce((sum, s) => sum + s.amount, 0);
                if (Math.abs(totalSplitAmount - totalAmount) > 0.001 || pendingSplits.length === 0) { 
                     await showModal("Validation Error", `The sum of split amounts (₹${totalSplitAmount.toLocaleString('en-IN')}) does not match the Total Transaction Amount (₹${totalAmount.toLocaleString('en-IN')}). Please correct the splits.`, false);
                     buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                     spinner.classList.add('hidden');
                     button.disabled = false;
                     return;
                }
                
                category = finalSplits[0].category;

                if (status === 'ADVANCE') {
                    expectedAmount = parseFloat($('expected-amount').value) || null;
                } else if (status === 'DUE') {
                    openDueId = $('open-advance-selector').value;
                    if (!openDueId) {
                        await showModal("Validation Error", "Please select an **Open Advance Transaction** to clear a due amount.", false);
                        buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                        spinner.classList.add('hidden');
                        button.disabled = false;
                        return;
                    }
                }
                
                if (finalSplits.length === 0) finalSplits = null;
            } else {
                status = 'FULL';
            }
            
            // 2. File Processing 
            const filesToKeep = pendingFiles.filter(f => !f.remove && ! (f instanceof File)); 
            const filesToUpload = pendingFiles.filter(f => f instanceof File); 
            if (filesToKeep.length + filesToUpload.length > 7) {
                 await showModal("Validation Error", `The total number of files exceeds the maximum limit of 7. Please remove files before saving.`, false);
                 buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                 spinner.classList.add('hidden');
                 button.disabled = false;
                 return;
            }

            let newFiles = [];
            try {
                const filePromises = filesToUpload.map(fileToBase64);
                newFiles = await Promise.all(filePromises);
            } catch (error) {
                await showModal("File Error", `One or more files exceeded the size limit (Max 200KB per file): ${error.message}`, false);
                buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                spinner.classList.add('hidden');
                button.disabled = false;
                return;
            }

            const finalFiles = filesToKeep.concat(newFiles);
            let isClosedStatus = type === 'INFLOW' || status === 'FULL'; 

            const transactionData = {
                date: date,
                time: time,
                type: type,
                mode: mode,
                amount: totalAmount, 
                narration: narration,
                files: finalFiles,
                status: status, 
                openDueId: type === 'INFLOW' ? null : openDueId,
                isClosed: status === 'ADVANCE' ? false : isClosedStatus, 
                splits: finalSplits,
                category: category, 
                expectedAmount: status === 'ADVANCE' ? expectedAmount : null, 
                modifiedAt: isModification ? new Date().toISOString() : null
            };

            // Set isClosed status for ADVANCE/DUE
            if (status === 'ADVANCE') { transactionData.isClosed = false; } 
            else if (status === 'DUE') { transactionData.isClosed = true; }


            // Precautionary prompt for ADVANCE modification
            if (status === 'ADVANCE' && isModification) {
                const amountChanged = currentTx.amount !== totalAmount;
                const expectedChanged = currentTx.expectedAmount !== expectedAmount;
                const splitsChanged = JSON.stringify(currentTx.splits) !== JSON.stringify(transactionData.splits);

                if (amountChanged || expectedChanged || splitsChanged) {
                    const keepOpen = await showModal(
                        "Advance Transaction Modified",
                        `Key values have changed. Do you want to keep this advance **OPEN** for future due payments? (Click **Yes, Proceed** to close it now, or **Cancel** to keep it open)`,
                        true 
                    );
                    transactionData.isClosed = !keepOpen; 
                } else {
                    transactionData.isClosed = currentTx.isClosed;
                }
            }


            // 4. Handle Complex Advance/Due Logic (Using Firestore Transaction)
            if (status === 'DUE' && openDueId) {
                try {
                    await runTransaction(db, async (t) => {
                        const advanceDocRef = doc(getTransactionCollectionRef(), openDueId);
                        const advanceDoc = await t.get(advanceDocRef);

                        if (!advanceDoc.exists()) throw new Error("Advance transaction not found for due clearance.");

                        const advanceTx = advanceDoc.data();
                        
                        const allRelated = allTransactions.filter(tx => (tx.id === advanceTx.id) || (tx.openDueId === advanceTx.id));
                        const totalPaidExcludingThisTx = allRelated.filter(tx => tx.id !== txId).reduce((sum, tx) => sum + tx.amount, 0);
                        const newTotalPaid = totalPaidExcludingThisTx + totalAmount; 
                        const totalExpectedAmount = advanceTx.expectedAmount || 0;
                        
                        let shouldCloseAdvance = false;
                        let promptClosure = false;
                        let closureMessage = '';

                        if (totalExpectedAmount > 0) {
                            if (newTotalPaid >= totalExpectedAmount) {
                                promptClosure = true;
                                closureMessage = newTotalPaid > totalExpectedAmount 
                                    ? `Total payment **exceeds** expected amount. Do you want to **CLOSE** the advance now?`
                                    : `Total payment meets expected amount. Do you want to **CLOSE** the advance now?`;
                            } 
                        } else {
                            promptClosure = true;
                            closureMessage = `The expected full amount was unknown. Total paid is now ₹${newTotalPaid.toLocaleString('en-IN')}. Do you confirm that this clears the due and you want to **CLOSE** the advance transaction now?`;
                        }
                        
                        if (promptClosure) {
                            shouldCloseAdvance = await showModal("Confirm Advance Closure", closureMessage, true);
                        } else {
                            shouldCloseAdvance = false;
                        }

                        t.update(advanceDocRef, { isClosed: shouldCloseAdvance, totalPaid: newTotalPaid });
                        t.set(transactionRef, transactionData);
                    });

                    await showModal("Due Clearance Recorded!", `Due payment of ₹${totalAmount.toLocaleString('en-IN')} recorded.`, false);

                } catch (error) {
                    console.error("Firestore Transaction Error:", error);
                    await showModal("Transaction Failed", `Due clearance could not be processed: ${error.message}`, false);
                    buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    return;
                }

            } else {
                // Handle standard FULL or ADVANCE transaction (or INFLOW)
                try {
                    const updateFields = {...transactionData};
                    if (updateFields.category !== undefined) delete updateFields.category;
                    if (updateFields.expectedAmount !== undefined && updateFields.status !== 'ADVANCE') delete updateFields.expectedAmount;
                    
                    await setDoc(transactionRef, updateFields);
                    await showModal("Success!", `Transaction recorded successfully. ID: ${transactionRef.id.substring(0, 8)}...`, false);
                } catch (error) {
                    console.error("Firestore Save Error:", error);
                    await showModal("Save Error", `Failed to record transaction: ${error.message}`, false);
                    buttonText.textContent = isModification ? 'Save Changes' : 'Record Transaction';
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    return;
                }
            }

            // 5. Reset Form/UI
            $('transaction-form').reset();
            initTransactionForm();
            setActiveTab('transaction-history');

            buttonText.textContent = 'Record Transaction';
            spinner.classList.add('hidden');
            button.disabled = false;
        };

        // --- TRANSACTION HISTORY LOGIC (UPDATED FOR BACKWARD COMPATIBILITY) ---

        const renderTransactionHistory = () => {
            $('history-loader').classList.add('hidden');
            const list = $('transaction-list');
            list.innerHTML = '';

            if (allTransactions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center p-4">No transactions recorded yet.</p>';
                return;
            }

            allTransactions.forEach(tx => {
                const isOutflow = tx.type === 'OUTFLOW';
                
                const splitsToDisplay = (tx.splits && tx.splits.length > 0)
                    ? tx.splits
                    : (tx.category ? [{ category: tx.category, amount: tx.amount }] : null);


                const statusColor = tx.status === 'FULL' ? 'bg-green-100 text-green-800' :
                                       tx.status === 'ADVANCE' && !tx.isClosed ? 'bg-yellow-100 text-yellow-800' :
                                       tx.status === 'ADVANCE' && tx.isClosed ? 'bg-gray-100 text-gray-600' :
                                       tx.status === 'DUE' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800';
                const typeColor = isOutflow ? 'text-red-600' : 'text-green-600';
                const icon = isOutflow ? 'arrow-down' : 'arrow-up';

                let details = '';
                let splitDetailsHtml = '';
                
                if (isOutflow) {
                    details += `<p class="text-xs text-gray-500 mt-1">Via ${tx.mode}</p>`;
                    
                    if (splitsToDisplay && splitsToDisplay.length > 0) {
                        splitDetailsHtml = splitsToDisplay.map(split => {
                            return `<span class="inline-block text-xs text-gray-700 mt-1 mr-2 px-2 py-0.5 bg-gray-100 rounded-full">${split.category}: ₹${split.amount.toLocaleString('en-IN')}</span>`;
                        }).join('');
                        details += `<div class="mt-1">${splitDetailsHtml}</div>`;
                    } else {
                        details += `<p class="text-xs text-red-500 mt-1">No category info.</p>`;
                    }

                    if (tx.status === 'ADVANCE') {
                        const expected = tx.expectedAmount > 0 ? ` (Exp: ₹${tx.expectedAmount.toLocaleString('en-IN')})` : '';
                        details += `<p class="text-xs text-yellow-700 font-medium mt-1">Advance. Total Paid: ₹${tx.amount.toLocaleString('en-IN')}${expected}${tx.isClosed ? ' (CLOSED)' : ' (OPEN)'}</p>`;
                    } else if (tx.status === 'DUE') {
                        details += `<p class="text-xs text-blue-700 font-medium mt-1">Due Clearance (Ref: ${tx.openDueId ? tx.openDueId.substring(0, 8) : '?'})</p>`;
                    }
                } else {
                    details += `<p class="text-xs text-gray-500 mt-1">Via ${tx.mode}</p>`;
                }

                let fileButtons = '';
                (tx.files || []).forEach((file, index) => {
                    const isBase64 = file.data && file.data.startsWith('data:');
                    if (isBase64) {
                        fileButtons += `
                            <a href="${file.data}" download="${file.name}"
                                class="text-xs inline-flex items-center text-blue-600 hover:text-blue-800 border border-blue-300 rounded-full px-2 py-1 transition duration-150">
                                <i data-lucide="download" class="w-3 h-3 mr-1"></i> ${file.name}
                            </a>
                        `;
                    } else {
                        fileButtons += `
                            <span class="text-xs inline-flex items-center text-gray-600 border border-gray-300 rounded-full px-2 py-1">
                                <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> File Missing/Error
                            </span>
                        `;
                    }
                });

                const item = document.createElement('div');
                item.className = 'card p-4 border border-gray-200';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="${icon}" class="w-5 h-5 ${typeColor}"></i>
                                <span class="font-bold ${typeColor} text-xl">₹${tx.amount.toLocaleString('en-IN')}</span>
                                <span class="text-xs font-semibold ${statusColor} px-2 py-0.5 rounded-full">${tx.status}</span>
                            </div>
                            <p class="text-sm text-gray-800 mt-1 truncate">${tx.narration || 'No Narration'}</p>
                            ${details}
                            <p class="text-xs text-gray-400 mt-1">${tx.date} at ${tx.time || '00:00'}</p>
                        </div>

                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-id="${tx.id}" class="modify-btn p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition duration-150" title="Modify">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button data-id="${tx.id}" class="delete-btn p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 space-x-2">
                        ${fileButtons || '<span class="text-xs text-gray-400">No bills uploaded.</span>'}
                    </div>
                `;
                list.appendChild(item);
            });

            lucide.createIcons();
            // Attach listeners to newly rendered buttons
            document.querySelectorAll('.modify-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const txId = e.currentTarget.dataset.id;
                const tx = allTransactions.find(t => t.id === txId);

                if (tx && tx.status === 'DUE' && tx.openDueId) {
                    const confirmReopen = await showModal("Modify Due Payment", `Modifying this Due Clearance payment requires temporarily **re-opening** the parent Advance transaction. Proceed?`, true);
                    if (!confirmReopen) return;

                    try {
                        await setDoc(doc(getTransactionCollectionRef(), tx.openDueId), { isClosed: false }, { merge: true });
                    } catch(error) {
                         await showModal("Error", "Failed to prepare parent advance for modification. Please try deleting the DUE transaction instead.", false);
                         return;
                    }
                }
                
                if (tx) {
                    setActiveTab('add-transaction');
                    populateFormForModification(tx);
                }
            }));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                 const txId = e.currentTarget.dataset.id;
                 const tx = allTransactions.find(t => t.id === txId);
                 
                 let promptMessage = "Are you sure you want to delete this transaction?";
                 if (tx.status === 'ADVANCE' && !tx.isClosed) promptMessage = `This is an **OPEN ADVANCE** transaction. Deleting it might break the record keeping if it has related DUE payments. Proceed?`;
                 if (tx.status === 'DUE') promptMessage = `This is a **DUE CLEARANCE** transaction. Deleting it will re-open the original advance if it was closed by this payment. Proceed?`;
                 
                 const confirmDelete = await showModal("Warning!", promptMessage, true);
                 if (confirmDelete) await handleDeleteTransaction(txId);
            }));
        };

        const handleDeleteTransaction = async (txId) => {
             const txToDelete = allTransactions.find(t => t.id === txId);
             if (!txToDelete) return;

             try {
                await runTransaction(db, async (t) => {
                    const txRef = doc(getTransactionCollectionRef(), txId);

                    if (txToDelete.status === 'DUE' && txToDelete.openDueId) {
                        const advanceDocRef = doc(getTransactionCollectionRef(), txToDelete.openDueId);
                        const allRelatedPayments = allTransactions.filter(tx => (tx.id === txToDelete.openDueId || tx.openDueId === txToDelete.openDueId) && tx.id !== txId);
                        const newTotalPaid = allRelatedPayments.reduce((sum, tx) => sum + tx.amount, 0);

                        const advanceDoc = await t.get(advanceDocRef);
                        if (advanceDoc.exists()) {
                            const advanceTx = advanceDoc.data();
                            const totalExpectedAmount = advanceTx.expectedAmount || 0;
                            let shouldReOpen = (totalExpectedAmount > 0 && newTotalPaid < totalExpectedAmount) || (totalExpectedAmount === 0 && advanceTx.isClosed);
                            
                            if (shouldReOpen) t.update(advanceDocRef, { isClosed: false });
                            t.update(advanceDocRef, { totalPaid: newTotalPaid });
                        }
                    }
                    t.delete(txRef);
                });
                await showModal("Deleted!", "The transaction has been successfully removed.", false);
             } catch (error) {
                console.error("Deletion Error:", error);
                await showModal("Deletion Failed", `Could not delete transaction: ${error.message}`, false);
             }
        };


        // --- DATA EXPORT LOGIC ---

        const populateExportCategoryFilter = () => {
            const filterSelect = $('filter-category');
            filterSelect.innerHTML = '<option value="all">All Categories</option>';

            EXPENSE_CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterSelect.appendChild(option);
            });
        };

        const runDataQuery = () => {
            const filterType = $('filter-type').value;
            const filterStatus = $('filter-status').value;
            const filterCategory = $('filter-category').value;
            const selectedColumns = Array.from(document.querySelectorAll('#column-selection input[name="col"]:checked')).map(input => input.value);
            const groupByField = $('group-by').value;
            const orderByField = $('order-by').value;
            const orderByDirection = $('order-dir').value;
            
            let filteredTransactions = allTransactions;

            // 1. Apply Filters
            if (filterType !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => tx.type === filterType);
            }
            if (filterStatus !== 'all') {
                 if (filterStatus === 'OPEN_ADVANCE') {
                    filteredTransactions = filteredTransactions.filter(tx => tx.status === 'ADVANCE' && !tx.isClosed);
                 } else {
                    filteredTransactions = filteredTransactions.filter(tx => tx.status === filterStatus);
                 }
            }
            if (filterCategory !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => {
                    if (tx.splits && tx.splits.length > 0) {
                        return tx.splits.some(split => split.category === filterCategory);
                    }
                    return tx.category === filterCategory;
                });
            }

            // 2. Prepare Detailed Rows (Splitting multi-category transactions)
            let detailedRows = [];

            filteredTransactions.forEach(tx => {
                const baseTx = {
                    date: `${tx.date} ${tx.time || '00:00'}`,
                    type: tx.type,
                    mode: tx.mode,
                    amount: parseFloat(tx.amount), // Use float for calculations
                    status: tx.status + (tx.isClosed === false ? ' (OPEN)' : (tx.isClosed === true && tx.status === 'ADVANCE' ? ' (CLOSED)' : '')),
                    narration: tx.narration,
                    expectedAmount: tx.expectedAmount ? parseFloat(tx.expectedAmount) : null
                };

                const splitsToReport = (tx.splits && tx.splits.length > 0) 
                    ? tx.splits 
                    : (tx.category ? [{ category: tx.category, amount: tx.amount }] : null);

                if (splitsToReport) {
                    splitsToReport.forEach(split => {
                        const category = split.category;
                        const spent = parseFloat(split.amount) || 0;
                        const budgetLimit = allBudgets[category]?.limit || 0;
                        const variance = budgetLimit - spent;
                        
                        // Create a row entry for each split item
                        let row = {
                            ...baseTx,
                            // Category-specific data (float values for aggregation/sorting)
                            category: category, 
                            spentPerCategory: spent,
                            budgetLimit: budgetLimit,
                            budgetVariance: variance,
                            // Need original full amount for sorting
                            amount: baseTx.amount 
                        };
                        detailedRows.push(row);
                    });
                }
            });

            let finalReportRows = [];

            // 3. Apply Grouping (Aggregation)
            if (groupByField && groupByField !== '') {
                const groupedData = {};

                detailedRows.forEach(row => {
                    const key = row[groupByField];
                    if (!key) return; // Skip if grouping key is null/undefined

                    if (!groupedData[key]) {
                        // Initialize group aggregation structure
                        groupedData[key] = {
                            [groupByField]: key, // The grouping identifier
                            spentPerCategory: 0,
                            budgetLimit: 0,
                            budgetVariance: 0,
                            transactionCount: 0,
                            totalAmount: 0,
                        };
                    }
                    
                    // Sum numeric fields
                    groupedData[key].spentPerCategory += row.spentPerCategory;
                    groupedData[key].totalAmount += row.amount; // Sum the main transaction amount field
                    groupedData[key].transactionCount++;
                    
                    // Budget aggregation: Only sum budget limit once per category if grouping by category
                    if (groupByField === 'category') {
                         groupedData[key].budgetLimit = allBudgets[key]?.limit || 0;
                    }
                });
                
                // Finalize aggregated rows
                finalReportRows = Object.values(groupedData).map(group => {
                     // Recalculate variance after summing spent amount
                     group.budgetVariance = group.budgetLimit - group.spentPerCategory; 
                     return group;
                });

            } else {
                // No Grouping: Use transaction-split rows prepared earlier
                finalReportRows = detailedRows;
            }

            // 4. Apply Sorting
            if (orderByField) {
                const sortKey = getReportHeader(orderByField);

                finalReportRows.sort((a, b) => {
                    const aVal = a[sortKey] || a[orderByField];
                    const bVal = b[sortKey] || b[orderByField];
                    let comparison = 0;

                    // Prioritize numerical comparison
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        comparison = aNum - bNum;
                    } else if (aVal && bVal) {
                        comparison = String(aVal).localeCompare(String(bVal));
                    }

                    return orderByDirection === 'asc' ? comparison : -comparison;
                });
            }


            // 5. Format and Render
            let reportRowsFormatted = [];
            finalReportRows.forEach(row => {
                let formattedRow = {};
                
                selectedColumns.forEach(col => {
                    const header = getReportHeader(col);
                    let value = row[col];

                    // Handle aggregated field mapping
                    if (groupByField && row.transactionCount) {
                        if (col === 'amount') {
                            value = row.totalAmount; // Total amount paid (sum of tx amounts)
                        } else if (col === 'spentPerCategory') {
                             value = row.spentPerCategory; // Total spent in that group
                        } else if (col === 'budgetLimit') {
                             value = row.budgetLimit;
                        } else if (col === 'budgetVariance') {
                             value = row.budgetVariance;
                        } else if (col === 'category' || col === 'type' || col === 'mode' || col === 'status') {
                             value = row[col]; // The grouping identifier
                        } else if (col === 'date' || col === 'narration' || col === 'expectedAmount') {
                             value = 'N/A (Grouped)'; // Fields not relevant in aggregated view
                        }
                    }

                    // Apply final formatting and add to row
                    if (value !== undefined) {
                        if (col === 'amount' || col === 'spentPerCategory' || col === 'budgetLimit' || col === 'budgetVariance') {
                             // Format financial values to 2 decimal places
                            formattedRow[header] = parseFloat(value).toFixed(2);
                        } else if (col === 'date' && !groupByField) {
                            formattedRow[header] = row.date; // Use original string from row
                        } else {
                            formattedRow[header] = value;
                        }
                    }
                });

                if (Object.keys(formattedRow).length > 0) {
                    reportRowsFormatted.push(formattedRow);
                }
            });

            renderReportTable(reportRowsFormatted);
        };
        
        // Helper function to map internal field names to display headers
        const getReportHeader = (fieldName) => {
            switch(fieldName) {
                case 'date': return 'Date & Time';
                case 'type': return 'Type';
                case 'mode': return 'Mode';
                case 'amount': return 'Amount Paid';
                case 'status': return 'Status';
                case 'narration': return 'Narration';
                case 'category': return 'Category';
                case 'budgetLimit': return 'Budget Limit';
                case 'spentPerCategory': return 'Spent per Category';
                case 'budgetVariance': return 'Budget Variance';
                case 'expectedAmount': return 'Expected Advance Amount';
                default: return fieldName;
            }
        };

        const renderReportTable = (reportRows) => {
            const table = $('report-table');
            const container = $('report-output-container');
            const message = container.querySelector('p');
            const copyBtn = $('copy-clipboard-btn');
            const downloadBtn = $('download-csv-btn');

            if (reportRows.length === 0) {
                message.classList.remove('hidden');
                table.classList.add('hidden');
                copyBtn.disabled = true;
                downloadBtn.disabled = true;
                message.textContent = "No data matched your current filter criteria.";
                currentReportData = '';
                return;
            }

            message.classList.add('hidden');
            table.classList.remove('hidden');
            copyBtn.disabled = false;
            downloadBtn.disabled = false;

            // Generate CSV content
            const headers = Object.keys(reportRows[0]);
            let csvContent = headers.join(',') + '\n';
            reportRows.forEach(row => {
                csvContent += headers.map(header => {
                    let value = row[header] === undefined ? '' : row[header];
                    // Escape commas and wrap in quotes
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',') + '\n';
            });
            currentReportData = csvContent;

            // Render HTML Table
            let tableHtml = `
                <thead>
                    <tr class="bg-gray-100">
                        ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
            `;
            reportRows.forEach(row => {
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    let value = row[header];
                    let colorClass = '';
                    if (header === 'Budget Variance') {
                        const variance = parseFloat(value);
                        if (variance < 0) {
                            colorClass = 'text-red-600 font-semibold';
                        } else if (variance > 0) {
                            colorClass = 'text-green-600 font-semibold';
                        }
                    }
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${colorClass}">${value}</td>`;
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody>`;
            table.innerHTML = tableHtml;
            
            // Re-run lucide icons for table
            lucide.createIcons();
        };

        const handleCopyClipboard = () => {
             navigator.clipboard.writeText(currentReportData)
                 .then(() => {
                     showModal("Success", "Report data (CSV format) copied to clipboard!", false);
                 })
                 .catch(err => {
                     console.error('Could not copy text: ', err);
                     showModal("Error", "Failed to copy data to clipboard. Try downloading the CSV instead.", false);
                 });
        };
        
        const handleDownloadCSV = () => {
             if (!currentReportData) return;
             
             const blob = new Blob([currentReportData], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.setAttribute('download', 'puja_finance_report.csv');
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             showModal("Success", "CSV file download initiated.", false);
        };


       


        const setActiveTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            $(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');

            if (tabName === 'add-transaction' && !$('transaction-id').value) {
                initTransactionForm();
            }
        };

        const handleLogin = () => {
            const inputPasscode = $('passcode-input').value;
            const errorDiv = $('login-error');

            if (inputPasscode === FAMILY_PASSCODE) {
                $('login-screen').classList.add('hidden');
                $('main-app').classList.remove('hidden');
                errorDiv.classList.add('hidden');
                localStorage.setItem('jpuja-passcode', FAMILY_PASSCODE); 
                initFirebase(); 
            } else {
                errorDiv.classList.remove('hidden');
            }
        };

        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            const storedPasscode = localStorage.getItem('jpuja-passcode');
            if (storedPasscode === FAMILY_PASSCODE) {
                handleLogin(); 
            }

            modalConfirm.addEventListener('click', () => modal.classList.add('opacity-0', 'invisible'));
            modalCancel.addEventListener('click', () => modal.classList.add('opacity-0', 'invisible'));

            $('login-button').addEventListener('click', handleLogin);
            $('passcode-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => setActiveTab(e.currentTarget.dataset.tab));
            });

            $('save-budget-btn').addEventListener('click', handleSaveBudgets);
            $('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            // Data Export Listeners
            $('run-query-btn').addEventListener('click', runDataQuery);
            $('copy-clipboard-btn').addEventListener('click', handleCopyClipboard);
            $('download-csv-btn').addEventListener('click', handleDownloadCSV);

            setActiveTab('dashboard');

            if (!$('main-app').classList.contains('hidden') && !app) {
                 initFirebase();
            }
        });

    </script>
</body>
</html>
